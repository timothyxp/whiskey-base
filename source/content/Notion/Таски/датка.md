---
Created: 2022-11-23T16:17
---
## PrePre

учим просто на доках, вопрос откуда эти доки брать

- доки из переформулировок(проблема что переформулировки старые)
    - сэмплить пропрционально показам/кликам/уникальные/просто так как есть
- попробовать намайнить просто из потока пропорционально кликам/показам
    - показы
    - клики -

  

## Pre

- переформулировки, к новому претрейну пересобрать их
- дедупликация ?

  

## Post

на последнем году учимся на релевах

  

## Данные

префикс - //home/factordev/timothyxp/bert/pretrain_datasets/

структура папок в arnold

- sessions
    
    - reformulations
        - 20_21_clicks_sampled - джоин уник доков из переформулировок с потоком кликов - [запрос](https://yql.yandex-team.ru/Operations/Y4S1erq3ky_ZypoDNOXxd69GekG0rIomwZvxG75-5Go=)
        - 20_21_views_samples - [запрос](https://yql.yandex-team.ru/Operations/Y4UIIa5OD_5DtWvFND1UpBiVnzEzmT1syDzzt-iAajI=)  
            джоин уник доков с потоком показов, тк из-за больших ключей не джойнилось там сплит таблы  
            
    - user_views_texts_2211-2111_joined_pretrain
        - pool - [запрос](https://yql.yandex-team.ru/Operations/Y4UBDbq3ky_Zy12I-_TkviwMAbGJEj8ZUONkYJNUL2w=) поля для препретрейна
    
    user_clicks_texts - уникальные урлы с доками уже - [граф](https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/64a10854-9067-496d-b03f-ce97c2d169a0/graph)
    
    user_clicks_pool - насэмплил по кликам рандомные урлы - [запрос](https://yql.yandex-team.ru/Queries/637f9dad97c5b76a0822cc87)
    
    user_views_pool - насэмплил по просмотрам рандомные урлы - [запрос](https://yql.yandex-team.ru/Queries/637f76a3bab793d644ec2d73)
    
    user_views_texts - уникальный урлы с доками - [граф](https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/9ee958e1-880f-442e-98df-fdf153158503/graph)
    
    user_clicks_joined - поджойнили док инфу обратно - [граф](https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/6c9b380b-b46b-47a0-9549-63e12c6e7c1e/graph)
    
    user_views_joined - поджойнили док инфу обратно - [граф](https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/d699a5f7-c37b-42c5-a19c-1349d8ed6985/graph)
    

  

в hahn кроме копий с arnold:

- sessions
    - reformulations
        
        - 20_21_clicks_sampled_urls - джоин уник доков перефорлировок с потоком кликовых - [запрос](https://yql.yandex-team.ru/Operations/Y4SPx65OD_5DtLQ8FyR0wu5NSHtka2KNQcOSpFm0zng=)
        - 20_21_uniq_docs - уникальный доки переформулировок 20-21 года [запрос](https://yql.yandex-team.ru/Operations/Y4SPx65OD_5DtLQ8FyR0wu5NSHtka2KNQcOSpFm0zng=)
        - 20_21_views_sampled_urls
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

## Эксперименты с данными для PrePreTrain

Ранее училось все на [https://yql.yandex-team.ru/Operations/5d702ac361e58ed1bcac2dab](https://yql.yandex-team.ru/Operations/5d702ac361e58ed1bcac2dab) которые был получен пересечением переформулировок с неизвестным датасетом. Попробовал собрать новый датасет на новых данных.

Будет 4 изначальных кандидата на датасеты:

- клики насэмплированные из потока - [https://yql.yandex-team.ru/Queries/637f9dad97c5b76a0822cc87](https://yql.yandex-team.ru/Queries/637f9dad97c5b76a0822cc87)
- показы с 1-й страницы насэмплированные из потока - [https://yql.yandex-team.ru/Operations/Y393Yrq3k9ZE7C8Rt0fyfsXcKTFbnyg4xJOUVsNJ5jo=](https://yql.yandex-team.ru/Operations/Y393Yrq3k9ZE7C8Rt0fyfsXcKTFbnyg4xJOUVsNJ5jo=)
- клики пересеченные с переформулировками - [https://yql.yandex-team.ru/Operations/Y4S1erq3ky_ZypoDNOXxd69GekG0rIomwZvxG75-5Go=](https://yql.yandex-team.ru/Operations/Y4S1erq3ky_ZypoDNOXxd69GekG0rIomwZvxG75-5Go=)
- показы пересеченные с переформулировками - [https://yql.yandex-team.ru/Operations/Y4UIIa5OD_5DtWvFND1UpBiVnzEzmT1syDzzt-iAajI=](https://yql.yandex-team.ru/Operations/Y4UIIa5OD_5DtWvFND1UpBiVnzEzmT1syDzzt-iAajI=)

  

Далее с помощью [https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/64a10854-9067-496d-b03f-ce97c2d169a0/graph](https://nirvana.yandex-team.ru/flow/8b26d209-c394-45f8-bdaf-eb725a7aee4c/64a10854-9067-496d-b03f-ce97c2d169a0/graph) доставал текст документов.

  

Валидироваться будем на LaVSinsig

|   |   |   |   |
|---|---|---|---|
|dataset type|simple(30К)|drop short(30К)|uniq(70К)|
|clicks uniform|[0.99](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/41aedd4a-9709-423a-8c0d-21db625490fb/graph)|[0.98](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/1cb4bec1-7528-4670-b7b7-40030ea95f10/graph)|[1.32](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/5f35d3b2-e3a9-4cd9-bedc-7d9ff4ef05c4/graph)|
|clicks reform intersect|[0.92](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/1d9eeb78-3bc3-4948-94e6-269dc45f70b9/graph)|[0.87](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/bc9c58f8-4e85-439e-a389-010d5325e515/graph)|[1.5](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/075140a3-033e-4a20-9b8f-02fd630c1c53/graph)|
|views uniform|[1.04](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/cc20f714-24dc-457a-96af-ac27c15f4330/graph)|[1.0](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/1206a386-d420-458d-9c5b-e2a317f6cece/graph)|[1,49](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/90ba4531-a4da-4dad-b0bb-919e6a6b41f3/graph)|
|views reform intersect|[0.92](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/f34862f9-1c65-49e8-92e0-73e8924df776/graph)|[0.88](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/62d572ac-b899-4a10-86aa-68d0707805c6/graph)|[1.5](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/eb55090b-888f-4826-9921-0fb440d753d8/graph)|
|olf_reform_train_text|[1.49](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/5bfed948-a712-4a2c-9749-3119f5886659/graph)|[1.51](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/08b4610c-7188-4703-b0b8-f008b9d4c11b/graph)|[1.85](https://nirvana.yandex-team.ru/flow/31fbc940-5e18-4a73-bd2b-4889706b338a/cc82218f-0550-4489-8fcc-032dab0a4a9d/graph)|

Теперь модификации датасетов:

- 1-й столбик: как есть так и засунул, видно что совсем плохо и проигрывает бейзлайну. MLM при этом был сильно ниже у новых датасетов
- 2-й столбик: глянул на статистики длины старого датасета - [https://yql.yandex-team.ru/Operations/Y4dqYZfFt2oIK6Svt0_l0C0KRW8URkQKceasSWKEBR4=](https://yql.yandex-team.ru/Operations/Y4dqYZfFt2oIK6Svt0_l0C0KRW8URkQKceasSWKEBR4=)
    
    и нового - [https://yql.yandex-team.ru/Operations/Y4do2a5OD_5DuDiEiFucsS-NF64MFTXZCLm6M2DbQlE=](https://yql.yandex-team.ru/Operations/Y4do2a5OD_5DuDiEiFucsS-NF64MFTXZCLm6M2DbQlE=)
    
    бросилось в глаза, что в старом явно пофильтрованы короткие доки, попробовал тоже пофильтровать, результатов не дало, как будто бы даже ухудшилось
    
- 3-й столбик. Еще изучив старый датасет понял что там дропнуты дипликаты - [https://yql.yandex-team.ru/Operations/Y4i_Tbq3k2nJ6BBV0PnyoaNTeo-oXIF_lt1Wjywy7R4=](https://yql.yandex-team.ru/Operations/Y4i_Tbq3k2nJ6BBV0PnyoaNTeo-oXIF_lt1Wjywy7R4=)  
    Дропнув их в своих эффект дало довольно сильный, но все равно до бейзлайна не дотягивает.  
      
    

Так как времени больше подбирать датасеты не было, оставил исходный. Нужны какие-то более сложные эвристики для буста скоров.

  

|   |   |   |   |
|---|---|---|---|
|датасет|step 30k(lav sinsing, squad)|step 40k|step 50k|
|reform_clicks|1.09 / 58.87 / 62.92|1.09 / 59.49 / 63.40|1.24 / 63.83 / 68.00|
|clicks|1.03 / 61.37 / 65.83|1.3 / 62.39 / 66.67|1.25 / 62.80 / 66.84|
|reform_views|0.99 /|1.1 / 63.33 / 67.53|1.24 / 63.60 / 67.88|

Еще попробовал запустить скрипт эдика для сборки датасета

|   |   |   |
|---|---|---|
|датасет|edikv4+unique-url|edikv4+simple|
|reform_clicks|1.236||
|clicks|1.25|1.26|
|reform_views|1.24|1.39|
|views||1.369|
|old-reform-texts(baseline)|1.84|1.84|